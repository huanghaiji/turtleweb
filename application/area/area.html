<!DOCTYPE html>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="./area.css"/>

    <div class="areadiv" onjs="api.areadiv = this;">
    </div>

    <div style="border-radius:1rem;background-color:#2b2b2b;padding:1rem;margin-top:1rem;color:white;">
        //传入一个function，用于每产生一个游标时，生成一行结果的数据。
        <br />
        a.cursor(this,rowdata(){},'cursorwindow','styleid');
        <br />
        //使用结果中的一个数据。
        <br />
        cursorwindow['sort'];
        <br />
        //peeknode,描述的是接收到一个数组结构的数据，需要使用该节点作为数组的子项使用。
        <br />
        //nextnode,则用于是否切换到下一组；
        <br />
        cursorwindow['turledata'].peeknode();cursorwindow['turledata'].nextnode();
        <br />
        //用于判断是否可继续迭代否。
        <br />
        cursorwindow['turledata'].hasnode();
        <br />
    </div>

<noscript id="areacontent">
    <table onjs="
        api.foreach(this, [api.areatimes], 'areatimes', 'areatitle');
        api.cursor(this, api.seatTable(), 'turlearea', 'areabody');">

        <tr styleid="areatitle" onjs="api.foreach(this, ['代号', ...areatimes], 'tim')">
            <td>{{tim}}</td>
        </tr>

        <tr styleid="areabody">
            <td colspan="5">{{turlearea.peek().name}}</td>
        </tr>

        <tr styleid="areabody" onjs="api.cursor(this, api.turtearray(turlearea.peek()), 'tud', 'tud2'); this.remove();">
            <td styleid="tud2">
                <script mode="onjs">
                    let str = '';
                    tud.peek().forEach((av) => {
                        str =str+ '<td>' + (av||'') + '</td>';
                    });
                    let tr2 = document.createElement('tr');
                    tr2.innerHTML = str;
                    queryparent(this, 'table').append(tr2);
                </script>
            </td>
        </tr>
    </table>

</noscript>

<script mode="params">
    const api = {

    }
    { { tud.peek() + "|" + JSON.stringify(turlearea.peek()) } }
</script>

<script>
    let areasort;
    let turtledata;
    let areatimes;

    seatTable = function () {
        let table = {};
        areasort.forEach((v) => {
            table[v] = { name: v,turs:[] };
        });
        turtledata.forEach((turtle) => {
            let turtleItem = table[turtle.areas][turtle.id];
            if (!turtleItem) {
                table[turtle.areas][turtle.id]
                    = turtleItem
                    = { nick: turtle.nick, id: turtle.id };
                table[turtle.areas].turs.push(turtle.id);
            }
            if (areatimes.indexOf(turtle.time) != -1) {
                turtleItem[turtle.time] = turtle.ag;
            }
        });
        console.info('区域数据', table);
        return table;
    }

    turtearray = function (area) {
        let array = [];
        area.turs.forEach((tn) => {
            let tur = area[tn];
            let turl = [tur.nick];
            areatimes.forEach((tim) => {
                turl.push(tur[tim])
            });
            array.push(turl);
        })
        console.info('<数组>', array);
        return array;
    }

    qurGet('./../../applicationDatas/area.json', (datacontent) => {
        let areadata = JSON.parse(datacontent);
        areasort = areadata.areasort;
        turtledata = areadata.turtledata;
        areatimes = areadata.areatimes;
        Aircraft(api.apiName, api.areadiv)
            .entitySets({
                areasort: areasort,
                turtledata: turtledata,
                areatimes: areatimes,
                seatTable: seatTable,
                turtearray: turtearray
                })
            .didAppend(api.global,api['#areacontent']);
    }, (error) => {
        alert(error + '\n' + JSON.stringify(error));
    })

</script>